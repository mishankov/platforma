---
title: database
---
import { LinkButton, Steps } from '@astrojs/starlight/components';

The `database` package provides PostgreSQL database connection and automatic migration functionality.

Core Components:

- `Database`: Manages database connection, repository registration, and migration execution
- `Migration`: Represents a database migration with `ID`, `Up`, and `Down` SQL statements
- `migrator` interface: Repositories implementing `Migrations() []Migration` are automatically migrated

[Full package docs at pkg.go.dev](https://pkg.go.dev/github.com/platforma-dev/platforma/database)

## Step-by-step guide

<Steps>

1. Create a new database connection

    ```go
    db, err := database.New("postgres://user:password@localhost:5432/mydb?sslmode=disable")
    if err != nil {
        log.ErrorContext(ctx, "failed to connect", "error", err)
        os.Exit(1)
    }
    ```

    The connection string follows standard PostgreSQL format.

2. Define a repository with migrations

    ```go
    type UserRepository struct {
        db *sqlx.DB
    }

    func NewUserRepository(db *sqlx.DB) *UserRepository {
        return &UserRepository{db: db}
    }

    func (r *UserRepository) Migrations() []database.Migration {
        return []database.Migration{
            {
                ID:   "create_users_table",
                Up:   "CREATE TABLE IF NOT EXISTS users (id SERIAL PRIMARY KEY, name TEXT NOT NULL)",
                Down: "DROP TABLE users",
            },
        }
    }
    ```

    The `Migrations()` method makes your repository a migrator. Each migration needs a unique `ID`, `Up` SQL to apply, and `Down` SQL to revert.

3. Get the underlying connection and create your repository

    ```go
    userRepo := NewUserRepository(db.Connection())
    ```

    `Connection()` returns the underlying `*sqlx.DB` for your repository operations.

4. Register the repository with the database

    ```go
    db.RegisterRepository("users", userRepo)
    ```

    Registration enables automatic migration when `Migrate()` is called.

5. Run migrations

    ```go
    err = db.Migrate(ctx)
    if err != nil {
        log.ErrorContext(ctx, "migration failed", "error", err)
        os.Exit(1)
    }
    ```

    Migrations are tracked in the `platforma_migrations` table. Only pending migrations are applied.

6. Use your repository

    ```go
    user, err := userRepo.Create(ctx, "John Doe")
    ```

    After migrations complete, your tables are ready for use.

</Steps>

## Using with Application

When using the `application` package, databases are migrated automatically during startup:

```go
app := application.New()

db, _ := database.New("postgres://user:pass@localhost:5432/mydb?sslmode=disable")
app.RegisterDatabase("main", db)

userRepo := NewUserRepository(db.Connection())
app.RegisterRepository("main", "users", userRepo)

app.RegisterService("api", httpServer)

app.Run(ctx)
```

The application runs migrations for all registered databases before starting services.

## Migration tracking

Migrations are tracked in the `platforma_migrations` table with three columns:

| Column | Description |
|--------|-------------|
| `repository` | Name used in `RegisterRepository` |
| `id` | Migration ID from your `Migrations()` method |
| `timestamp` | When the migration was applied |

If a migration fails, previously applied migrations in the same batch are reverted using their `Down` SQL.

## Complete example

import { Code } from '@astrojs/starlight/components';
import importedCode from '../../../../../demo-app/cmd/database/main.go?raw';

<Code code={importedCode} lang="go" title="database.go" />
